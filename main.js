var _readers;

async function ListReaders() {
  let reader_ul = document.getElementById('readerList');
  while (reader_ul.firstChild) {
    reader_ul.removeChild(reader_ul.firstChild);
  }
  _readers = await navigator.webcard.readers();
  console.log(_readers.length + " readers detected");
  _readers.forEach((reader, index) => {
    let node = document.createElement('li');
    reader_ul.append(node)
    node.outerHTML = `
    <li><a class="dropdown-item" tabindex="${index}" href="#">
      ${reader.name}
    </a></li>
    `;
  });
  if (_readers.length > 0) {
    let button = reader_ul.parentElement.firstElementChild;
    button.innerHTML = `${_readers[0].name}`;
    button.disabled = false;
  }
}

async function CreateFIDOCredentials(index, count) {
  console.log('Creating ' + count + ' FIDO credentials in ' + _readers[index].name);
  let startTime = new Date();
  let atr = await _readers[index].connect(true);
  let createCreds = [
    ['80100000BF01A5015820CAB2210B9A3AE4F877F8ED56318C2CE5D9D2DE8326B70CA0174B55F2DA18EE6A02A2626964736C6F67696E2E6D6963726F736F66742E636F6D646E616D65694D6963726F736F667403A36269644E6B65793140676D61696C2E636F6D646E616D6578196869642E676C6F62616C2E6B65793140676D61696C2E636F6D6469636F6E78196869642E676C6F62616C2E6B65793140676D61696C2E636F6D0481A263616C672664747970656A7075626C69632D6B657907A162726BF500'], 

    ['90100000FF01A5015820973FB38535A114040E5483632A8F66404374676B79F2CAE947EAFD3FB69071ED02A2626964736C6F67696E2E6D6963726F736F66742E636F6D646E616D65694D6963726F736F667403A46269644E6B65793240676D61696C2E636F6D646E616D6578196869642E676C6F62616C2E6B65793240676D61696C2E636F6D6469636F6E78C868747470733A2F2F73746F726167652E6C6976652E636F6D2F75736572732F3078414439443534463044344431384542352F6D7970726F66696C652F65787072657373696F6E70726F66696C652F70726F66696C6570686F746F3A5573657254696C655374617469632F50726F66696C65496D6167653F', 
    '80100000AE636B3D312F73746F726167652E6C6976652E636F6D2F75736572732F3078414439443534463044344431384542352F6D7970726F66696C652F65787072657373696F6E70726F66696C652F70726F3132336B646973706C61794E616D6578196869642E676C6F62616C2E6B65793240676D61696C2E636F6D0482A263616C672664747970656A7075626C69632D6B6579A263616C6739010064747970656A7075626C69632D6B657907A162726BF500'], 
    
    ['80100000BF01A5015820CAB2210B9A3AE4F877F8ED56318C2CE5D9D2DE8326B70CA0174B55F2DA18EE6A02A2626964736C6F67696E2E6D6963726F736F66742E636F6D646E616D65694D6963726F736F667403A36269644E6B65793340676D61696C2E636F6D646E616D6578196869642E676C6F62616C2E6B65793340676D61696C2E636F6D6469636F6E78196869642E676C6F62616C2E6B65793340676D61696C2E636F6D0481A263616C672664747970656A7075626C69632D6B657907A162726BF500'], 
    
    ['90100000FF01A5015820973FB38535A114040E5483632A8F66404374676B79F2CAE947EAFD3FB69071ED02A2626964736C6F67696E2E6D6963726F736F66742E636F6D646E616D65694D6963726F736F667403A46269644E6B65793440676D61696C2E636F6D646E616D6578196869642E676C6F62616C2E6B65793440676D61696C2E636F6D6469636F6E78C868747470733A2F2F73746F726167652E6C6976652E636F6D2F75736572732F3078414439443534463044344431384542352F6D7970726F66696C652F65787072657373696F6E70726F66696C652F70726F66696C6570686F746F3A5573657254696C655374617469632F50726F66696C65496D6167653F', 
    '80100000AE636B3D312F73746F726167652E6C6976652E636F6D2F75736572732F3078414439443534463044344431384542352F6D7970726F66696C652F65787072657373696F6E70726F66696C652F70726F3132336B646973706C61794E616D6578196869642E676C6F62616C2E6B65793440676D61696C2E636F6D0482A263616C672664747970656A7075626C69632D6B6579A263616C6739010064747970656A7075626C69632D6B657907A162726BF500'], 
    
    ['80100000BF01A5015820CAB2210B9A3AE4F877F8ED56318C2CE5D9D2DE8326B70CA0174B55F2DA18EE6A02A2626964736C6F67696E2E6D6963726F736F66742E636F6D646E616D65694D6963726F736F667403A36269644E6B65793540676D61696C2E636F6D646E616D6578196869642E676C6F62616C2E6B65793540676D61696C2E636F6D6469636F6E78196869642E676C6F62616C2E6B65793540676D61696C2E636F6D0481A263616C672664747970656A7075626C69632D6B657907A162726BF500'], 
    
    ['90100000FF01A5015820973FB38535A114040E5483632A8F66404374676B79F2CAE947EAFD3FB69071ED02A2626964736C6F67696E2E6D6963726F736F66742E636F6D646E616D65694D6963726F736F667403A46269644E6B65793640676D61696C2E636F6D646E616D6578196869642E676C6F62616C2E6B65793640676D61696C2E636F6D6469636F6E78C868747470733A2F2F73746F726167652E6C6976652E636F6D2F75736572732F3078414439443534463044344431384542352F6D7970726F66696C652F65787072657373696F6E70726F66696C652F70726F66696C6570686F746F3A5573657254696C655374617469632F50726F66696C65496D6167653F', 
    '80100000AE636B3D312F73746F726167652E6C6976652E636F6D2F75736572732F3078414439443534463044344431384542352F6D7970726F66696C652F65787072657373696F6E70726F66696C652F70726F3132336B646973706C61794E616D6578196869642E676C6F62616C2E6B65793640676D61696C2E636F6D0482A263616C672664747970656A7075626C69632D6B6579A263616C6739010064747970656A7075626C69632D6B657907A162726BF500'], 
    
    ['80100000BF01A5015820CAB2210B9A3AE4F877F8ED56318C2CE5D9D2DE8326B70CA0174B55F2DA18EE6A02A2626964736C6F67696E2E6D6963726F736F66742E636F6D646E616D65694D6963726F736F667403A36269644E6B65793740676D61696C2E636F6D646E616D6578196869642E676C6F62616C2E6B65793740676D61696C2E636F6D6469636F6E78196869642E676C6F62616C2E6B65793740676D61696C2E636F6D0481A263616C672664747970656A7075626C69632D6B657907A162726BF500'], 
    
    ['90100000FF01A5015820973FB38535A114040E5483632A8F66404374676B79F2CAE947EAFD3FB69071ED02A2626964736C6F67696E2E6D6963726F736F66742E636F6D646E616D65694D6963726F736F667403A46269644E6B65793840676D61696C2E636F6D646E616D6578196869642E676C6F62616C2E6B65793840676D61696C2E636F6D6469636F6E78C868747470733A2F2F73746F726167652E6C6976652E636F6D2F75736572732F3078414439443534463044344431384542352F6D7970726F66696C652F65787072657373696F6E70726F66696C652F70726F66696C6570686F746F3A5573657254696C655374617469632F50726F66696C65496D6167653F', 
    '80100000AE636B3D312F73746F726167652E6C6976652E636F6D2F75736572732F3078414439443534463044344431384542352F6D7970726F66696C652F65787072657373696F6E70726F66696C652F70726F3132336B646973706C61794E616D6578196869642E676C6F62616C2E6B65793840676D61696C2E636F6D0482A263616C672664747970656A7075626C69632D6B6579A263616C6739010064747970656A7075626C69632D6B657907A162726BF500'], 
    
    ['80100000BF01A5015820CAB2210B9A3AE4F877F8ED56318C2CE5D9D2DE8326B70CA0174B55F2DA18EE6A02A2626964736C6F67696E2E6D6963726F736F66742E636F6D646E616D65694D6963726F736F667403A36269644E6B65793940676D61696C2E636F6D646E616D6578196869642E676C6F62616C2E6B65793940676D61696C2E636F6D6469636F6E78196869642E676C6F62616C2E6B65793940676D61696C2E636F6D0481A263616C672664747970656A7075626C69632D6B657907A162726BF500'], 
    
    ['90100000FF01A50158201A57C67527BF172086C7D79A2CDAD54486FF08066DFF249457CA6FF0CA17D13102A2626964736C6F67696E2E6D6963726F736F66742E636F6D646E616D65694D6963726F736F667403A46269644F6B6579313040676D61696C2E636F6D646E616D65781A6869642E676C6F62616C2E6B6579313040676D61696C2E636F6D6469636F6E78C868747470733A2F2F73746F726167652E6C6976652E636F6D2F75736572732F3078414439443534463044344431384542352F6D7970726F66696C652F65787072657373696F6E70726F66696C652F70726F66696C6570686F746F3A5573657254696C655374617469632F50726F66696C65496D6167', 
    '80100000B1653F636B3D312F73746F726167652E6C6976652E636F6D2F75736572732F3078414439443534463044344431384542352F6D7970726F66696C652F65787072657373696F6E70726F66696C652F70726F3132336B646973706C61794E616D65781A6869642E676C6F62616C2E6B6579313040676D61696C2E636F6D0482A263616C672664747970656A7075626C69632D6B6579A263616C6739010064747970656A7075626C69632D6B657907A162726BF500'], 
    
    ['80100000DF01A601582049DBC6913C067728B423CD5CBB673F94AC0B2A89EA3A234DD12D8C8BED95651002A2626964736C6F67696E2E6D6963726F736F66742E636F6D646E616D65694D6963726F736F667403A3626964456B65793131646E616D65781A6869642E676C6F62616C2E6B6579313140676D61696C2E636F6D6469636F6E781A6869642E676C6F62616C2E6B6579313140676D61696C2E636F6D0482A263616C672664747970656A7075626C69632D6B6579A263616C6739010064747970656A7075626C69632D6B657906A16B686D61632D736563726574F507A162726BF500'], 
    
    ['90100000FF01A50158201A57C67527BF172086C7D79A2CDAD54486FF08066DFF249457CA6FF0CA17D13102A2626964736C6F67696E2E6D6963726F736F66742E636F6D646E616D65694D6963726F736F667403A46269644F6B6579313240676D61696C2E636F6D646E616D65781A6869642E676C6F62616C2E6B6579313240676D61696C2E636F6D6469636F6E78C868747470733A2F2F73746F726167652E6C6976652E636F6D2F75736572732F3078414439443534463044344431384542352F6D7970726F66696C652F65787072657373696F6E70726F66696C652F70726F66696C6570686F746F3A5573657254696C655374617469632F50726F66696C65496D6167', 
    '80100000B1653F636B3D312F73746F726167652E6C6976652E636F6D2F75736572732F3078414439443534463044344431384542352F6D7970726F66696C652F65787072657373696F6E70726F66696C652F70726F3132336B646973706C61794E616D65781A6869642E676C6F62616C2E6B6579313240676D61696C2E636F6D0482A263616C672664747970656A7075626C69632D6B6579A263616C6739010064747970656A7075626C69632D6B657907A162726BF500'], 
    
    ['80100000DF01A601582049DBC6913C067728B423CD5CBB673F94AC0B2A89EA3A234DD12D8C8BED95651002A2626964736C6F67696E2E6D6963726F736F66742E636F6D646E616D65694D6963726F736F667403A3626964456B65793133646E616D65781A6869642E676C6F62616C2E6B6579313340676D61696C2E636F6D6469636F6E781A6869642E676C6F62616C2E6B6579313340676D61696C2E636F6D0482A263616C672664747970656A7075626C69632D6B6579A263616C6739010064747970656A7075626C69632D6B657906A16B686D61632D736563726574F507A162726BF500'], 
    
    ['90100000FF01A50158201A57C67527BF172086C7D79A2CDAD54486FF08066DFF249457CA6FF0CA17D13102A2626964736C6F67696E2E6D6963726F736F66742E636F6D646E616D65694D6963726F736F667403A46269644F6B6579313440676D61696C2E636F6D646E616D65781A6869642E676C6F62616C2E6B6579313440676D61696C2E636F6D6469636F6E78C868747470733A2F2F73746F726167652E6C6976652E636F6D2F75736572732F3078414439443534463044344431384542352F6D7970726F66696C652F65787072657373696F6E70726F66696C652F70726F66696C6570686F746F3A5573657254696C655374617469632F50726F66696C65496D6167', 
    '80100000B1653F636B3D312F73746F726167652E6C6976652E636F6D2F75736572732F3078414439443534463044344431384542352F6D7970726F66696C652F65787072657373696F6E70726F66696C652F70726F3132336B646973706C61794E616D65781A6869642E676C6F62616C2E6B6579313440676D61696C2E636F6D0482A263616C672664747970656A7075626C69632D6B6579A263616C6739010064747970656A7075626C69632D6B657907A162726BF500'], 
    
    ['80100000DF01A601582049DBC6913C067728B423CD5CBB673F94AC0B2A89EA3A234DD12D8C8BED95651002A2626964736C6F67696E2E6D6963726F736F66742E636F6D646E616D65694D6963726F736F667403A3626964456B65793135646E616D65781A6869642E676C6F62616C2E6B6579313540676D61696C2E636F6D6469636F6E781A6869642E676C6F62616C2E6B6579313540676D61696C2E636F6D0482A263616C672664747970656A7075626C69632D6B6579A263616C6739010064747970656A7075626C69632D6B657906A16B686D61632D736563726574F507A162726BF500'], 
    
    ['90100000FF01A50158201A57C67527BF172086C7D79A2CDAD54486FF08066DFF249457CA6FF0CA17D13102A2626964736C6F67696E2E6D6963726F736F66742E636F6D646E616D65694D6963726F736F667403A46269644F6B6579313640676D61696C2E636F6D646E616D65781A6869642E676C6F62616C2E6B6579313640676D61696C2E636F6D6469636F6E78C868747470733A2F2F73746F726167652E6C6976652E636F6D2F75736572732F3078414439443534463044344431384542352F6D7970726F66696C652F65787072657373696F6E70726F66696C652F70726F66696C6570686F746F3A5573657254696C655374617469632F50726F66696C65496D6167', 
    '80100000B1653F636B3D312F73746F726167652E6C6976652E636F6D2F75736572732F3078414439443534463044344431384542352F6D7970726F66696C652F65787072657373696F6E70726F66696C652F70726F3132336B646973706C61794E616D65781A6869642E676C6F62616C2E6B6579313640676D61696C2E636F6D0482A263616C672664747970656A7075626C69632D6B6579A263616C6739010064747970656A7075626C69632D6B657907A162726BF500'], 
    
    ['80100000DF01A601582049DBC6913C067728B423CD5CBB673F94AC0B2A89EA3A234DD12D8C8BED95651002A2626964736C6F67696E2E6D6963726F736F66742E636F6D646E616D65694D6963726F736F667403A3626964456B65793137646E616D65781A6869642E676C6F62616C2E6B6579313740676D61696C2E636F6D6469636F6E781A6869642E676C6F62616C2E6B6579313740676D61696C2E636F6D0482A263616C672664747970656A7075626C69632D6B6579A263616C6739010064747970656A7075626C69632D6B657906A16B686D61632D736563726574F507A162726BF500'], 
    
    ['90100000FF01A50158201A57C67527BF172086C7D79A2CDAD54486FF08066DFF249457CA6FF0CA17D13102A2626964736C6F67696E2E6D6963726F736F66742E636F6D646E616D65694D6963726F736F667403A46269644F6B6579313840676D61696C2E636F6D646E616D65781A6869642E676C6F62616C2E6B6579313840676D61696C2E636F6D6469636F6E78C868747470733A2F2F73746F726167652E6C6976652E636F6D2F75736572732F3078414439443534463044344431384542352F6D7970726F66696C652F65787072657373696F6E70726F66696C652F70726F66696C6570686F746F3A5573657254696C655374617469632F50726F66696C65496D6167', 
    '80100000B1653F636B3D312F73746F726167652E6C6976652E636F6D2F75736572732F3078414439443534463044344431384542352F6D7970726F66696C652F65787072657373696F6E70726F66696C652F70726F3132336B646973706C61794E616D65781A6869642E676C6F62616C2E6B6579313840676D61696C2E636F6D0482A263616C672664747970656A7075626C69632D6B6579A263616C6739010064747970656A7075626C69632D6B657907A162726BF500'], 
    
    ['80100000DF01A601582049DBC6913C067728B423CD5CBB673F94AC0B2A89EA3A234DD12D8C8BED95651002A2626964736C6F67696E2E6D6963726F736F66742E636F6D646E616D65694D6963726F736F667403A3626964456B65793139646E616D65781A6869642E676C6F62616C2E6B6579313940676D61696C2E636F6D6469636F6E781A6869642E676C6F62616C2E6B6579313940676D61696C2E636F6D0482A263616C672664747970656A7075626C69632D6B6579A263616C6739010064747970656A7075626C69632D6B657906A16B686D61632D736563726574F507A162726BF500'], 
    
    ['90100000FF01A50158201A57C67527BF172086C7D79A2CDAD54486FF08066DFF249457CA6FF0CA17D13102A2626964736C6F67696E2E6D6963726F736F66742E636F6D646E616D65694D6963726F736F667403A46269644F6B6579323040676D61696C2E636F6D646E616D65781A6869642E676C6F62616C2E6B6579323040676D61696C2E636F6D6469636F6E78C868747470733A2F2F73746F726167652E6C6976652E636F6D2F75736572732F3078414439443534463044344431384542352F6D7970726F66696C652F65787072657373696F6E70726F66696C652F70726F66696C6570686F746F3A5573657254696C655374617469632F50726F66696C65496D6167', 
    '80100000B1653F636B3D312F73746F726167652E6C6976652E636F6D2F75736572732F3078414439443534463044344431384542352F6D7970726F66696C652F65787072657373696F6E70726F66696C652F70726F3132336B646973706C61794E616D65781A6869642E676C6F62616C2E6B6579323040676D61696C2E636F6D0482A263616C672664747970656A7075626C69632D6B6579A263616C6739010064747970656A7075626C69632D6B657907A162726BF500'], 
    
    ['80100000DF01A601582049DBC6913C067728B423CD5CBB673F94AC0B2A89EA3A234DD12D8C8BED95651002A2626964736C6F67696E2E6D6963726F736F66742E636F6D646E616D65694D6963726F736F667403A3626964456B65793231646E616D65781A6869642E676C6F62616C2E6B6579323140676D61696C2E636F6D6469636F6E781A6869642E676C6F62616C2E6B6579323140676D61696C2E636F6D0482A263616C672664747970656A7075626C69632D6B6579A263616C6739010064747970656A7075626C69632D6B657906A16B686D61632D736563726574F507A162726BF500'], 
    
    ['90100000FF01A50158201A57C67527BF172086C7D79A2CDAD54486FF08066DFF249457CA6FF0CA17D13102A2626964736C6F67696E2E6D6963726F736F66742E636F6D646E616D65694D6963726F736F667403A46269644F6B6579323240676D61696C2E636F6D646E616D65781A6869642E676C6F62616C2E6B6579323240676D61696C2E636F6D6469636F6E78C868747470733A2F2F73746F726167652E6C6976652E636F6D2F75736572732F3078414439443534463044344431384542352F6D7970726F66696C652F65787072657373696F6E70726F66696C652F70726F66696C6570686F746F3A5573657254696C655374617469632F50726F66696C65496D6167', 
    '80100000B1653F636B3D312F73746F726167652E6C6976652E636F6D2F75736572732F3078414439443534463044344431384542352F6D7970726F66696C652F65787072657373696F6E70726F66696C652F70726F3132336B646973706C61794E616D65781A6869642E676C6F62616C2E6B6579323240676D61696C2E636F6D0482A263616C672664747970656A7075626C69632D6B6579A263616C6739010064747970656A7075626C69632D6B657907A162726BF500'], 
    
    ['80100000DF01A601582049DBC6913C067728B423CD5CBB673F94AC0B2A89EA3A234DD12D8C8BED95651002A2626964736C6F67696E2E6D6963726F736F66742E636F6D646E616D65694D6963726F736F667403A3626964456B65793233646E616D65781A6869642E676C6F62616C2E6B6579323340676D61696C2E636F6D6469636F6E781A6869642E676C6F62616C2E6B6579323340676D61696C2E636F6D0482A263616C672664747970656A7075626C69632D6B6579A263616C6739010064747970656A7075626C69632D6B657906A16B686D61632D736563726574F507A162726BF500'], 
    
    ['90100000FF01A50158201A57C67527BF172086C7D79A2CDAD54486FF08066DFF249457CA6FF0CA17D13102A2626964736C6F67696E2E6D6963726F736F66742E636F6D646E616D65694D6963726F736F667403A46269644F6B6579323440676D61696C2E636F6D646E616D65781A6869642E676C6F62616C2E6B6579323440676D61696C2E636F6D6469636F6E78C868747470733A2F2F73746F726167652E6C6976652E636F6D2F75736572732F3078414439443534463044344431384542352F6D7970726F66696C652F65787072657373696F6E70726F66696C652F70726F66696C6570686F746F3A5573657254696C655374617469632F50726F66696C65496D6167', 
    '80100000B1653F636B3D312F73746F726167652E6C6976652E636F6D2F75736572732F3078414439443534463044344431384542352F6D7970726F66696C652F65787072657373696F6E70726F66696C652F70726F3132336B646973706C61794E616D65781A6869642E676C6F62616C2E6B6579323440676D61696C2E636F6D0482A263616C672664747970656A7075626C69632D6B6579A263616C6739010064747970656A7075626C69632D6B657907A162726BF500'], 
    
    ['80100000DF01A601582049DBC6913C067728B423CD5CBB673F94AC0B2A89EA3A234DD12D8C8BED95651002A2626964736C6F67696E2E6D6963726F736F66742E636F6D646E616D65694D6963726F736F667403A3626964456B65793235646E616D65781A6869642E676C6F62616C2E6B6579323540676D61696C2E636F6D6469636F6E781A6869642E676C6F62616C2E6B6579323540676D61696C2E636F6D0482A263616C672664747970656A7075626C69632D6B6579A263616C6739010064747970656A7075626C69632D6B657906A16B686D61632D736563726574F507A162726BF500']
  ];
  if (count > 25) count = 25;
  let res = await _readers[index].transcieve('00A4040008A0000006472F0001');
  let output = res;
  for (let i = 0; i < count; i++) {
    for (const command of createCreds[i]) {
      console.log(command);
      res = await _readers[index].transcieve(command);
      console.log(res);
      output += '> ' + command + '\n<' + res + '\n';
    }
  }
  _readers[index].disconnect();
  let elapsed = new Date() - startTime;
  output += 'Total: ' + elapsed + 'ms'
  console.log(output);
}

async function CreatePKICredentials(index, count) {

}

async function CreateCredentials(index) {
  let count = document.getElementById('credentialCount').value;
  switch (document.getElementById('credentialType').value) {
    case 'FIDO':
      await CreateFIDOCredentials(index, count);
      break;
    case 'PKI':
      await CreatePKICredentials(index, count);
      break;
  }
}

async function GetMemory(index) {
  console.log('Get Memory from ' + _readers[index].name);
  let atr = await _readers[index].connect(true);
  let output = '';
  let res = await _readers[index].transcieve('00A4040000');
  res = await _readers[index].transcieve('80CA00FE02DF25');
  console.log('< ' + res + '\n');
  document.getElementById('memoryAvailable').innerHTML = parseInt('0x' + res.substr(38, 8), 16);
  _readers[index].disconnect();
}

async function ResetCard(index) {
  console.log('Resetting card in ' + _readers[index].name);
  let atr = await _readers[index].connect(true);
  let output = '';
  let res = await _readers[index].transcieve('00A4040007A0000000791000');
  console.log('< ' + res + '\n');
  res = await _readers[index].transcieve('00200000083030303030303030');
  console.log('< ' + res + '\n');
  res = await _readers[index].transcieve('80380000');
  console.log('< ' + res + '\n');
  res = await _readers[index].transcieve('00A4040008A0000006472F0001');
  console.log('< ' + res + '\n');
  res = await _readers[index].transcieve('801000000107');
  console.log('< ' + res + '\n');
  _readers[index].disconnect();
  GetMemory(index);
}

navigator.webcard.cardInserted = function(reader) {
  console.log('Card inserted in ' + reader.name);
}

navigator.webcard.cardRemoved = function(reader) {
  console.log('Card removed from ' + reader.name)
}